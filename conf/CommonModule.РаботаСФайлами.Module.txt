Функция АдресВопросовПоУмолчанию() Экспорт
	Возврат "https://raw.githubusercontent.com/partizand/MobileProf/master/q.xml";	
КонецФункции


Функция ПолучитьФайлССервера(ПолныйАдресРесурса) 
	
	СтруктураURI = СтруктураURI(ПолныйАдресРесурса);
	
	
	Если СтруктураURI.Схема = "http" Тогда
		ЗащСоединение = Неопределено;
	Иначе
		ЗащСоединение = Новый ЗащищенноеСоединениеOpenSSL(); 
	КонецЕсли;
	
	Попытка	
			Соединение = Новый HTTPСоединение( СтруктураURI.Хост,СтруктураURI.Порт,,,,,ЗащСоединение,);
    Исключение
        Сообщить("Нет соединения");
        Возврат Неопределено;
    КонецПопытки;
 
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();

	Попытка
		Соединение.Получить(СтруктураURI.ПутьНаСервере,ИмяФайлаОтвета);
	Исключение
		 // исключение здесь говорит о том, что запрос не дошел до HTTP-Сервера
		 Сообщить("Произошла сетевая ошибка!");
		 //ВызватьИсключение;
		 Возврат Неопределено;
	 КонецПопытки;
 
    ФайлОтвета = Новый Файл(ИмяФайлаОтвета);
    Если ФайлОтвета.Существует() Тогда
		Возврат ИмяФайлаОтвета;
		
    Иначе
        Сообщить("не получилось получить данные");
        Возврат Неопределено;
    КонецЕсли;	
КонецФункции

Процедура ОтправитьФайлНаСервер(ПолныйАдресРесурса, ИмяФайлаОтправки)
	СтруктураURI = СтруктураURI(ПолныйАдресРесурса);
	
	
	
	Попытка
        Соединение = Новый HTTPСоединение(СтруктураURI.Хост,СтруктураURI.Порт,,,,,);
		
		HTTPЗапрос = Новый HTTPЗапрос(СтруктураURI.ПутьНаСервере);
    	HTTPЗапрос.УстановитьИмяФайлаТела(ИмяФайлаОтправки);
	    Результат  = Соединение.ОтправитьДляОбработки(HTTPЗапрос );
	    Соединение = Неопределено;
	
		//Соединение.ОтправитьДляОбработки(ИмяФайлаОтправки, СтруктураURI.ПутьНаСервере, имяВыходногоФайла); Получить(СтруктураURI.ПутьНаСервере,ИмяФайлаОтвета);
		
		Сообщить("Файл отправлен на сервер");
		
	Исключение
        Сообщить("Нет соединения");
        
    КонецПопытки;

КонецПроцедуры

Процедура ВыгрузитьВопросыВФайл(ИмяФайла) Экспорт
	Если ИмяФайлаЭтоВеб(ИмяФайла) Тогда
		ВременноеИмяФайла = ПолучитьИмяВременногоФайла("xml");
		ВыгрузитьВопросыВXML(ВременноеИмяФайла);
		ОтправитьФайлНаСервер(ИмяФайла, ВременноеИмяФайла);
		УдалитьФайлы(ВременноеИмяФайла);
		
	Иначе
		ВыгрузитьВопросыВXML(ИмяФайла);
	
	КонецЕсли
	
	
КонецПроцедуры


Процедура ВыгрузитьВопросыВXML(ИмяФайла)
	//РегистрыСведений.ХранилищеНастроек.ЗаписатьНастройку("ПутьКФайлу", ПутьКФайлу) ;
	Запись = Новый ЗаписьXML;
	Запись.ОткрытьФайл(ИмяФайла, "UTF-8");
	Запись.ЗаписатьОбъявлениеXML();
	ВыборкаРазделы = Справочники.Разделы.Выбрать();
	Запись.ЗаписатьНачалоЭлемента("OBJECTS");
	Пока ВыборкаРазделы.Следующий() Цикл
		ЗаписатьXML(Запись, ВыборкаРазделы.Ссылка.ПолучитьОбъект());
	КонецЦикла;
	
	ВыборкаВопросы = Справочники.ВопросыИОтветы.Выбрать();
	Пока ВыборкаВопросы.Следующий() Цикл
		ЗаписатьXML(Запись, ВыборкаВопросы.Ссылка.ПолучитьОбъект());
	КонецЦикла;
	
	Запись.ЗаписатьКонецЭлемента();//OBJECTS
	Запись.Закрыть();
	//Сообщить("Выгружено! Файл "+ПутьКФайлу);
КонецПроцедуры

Функция ИмяФайлаЭтоВеб(ИмяФайла)
	Веб =  "http://";
	Веб2 = "https://";
	
	ПозВеб=НАйти(ИмяФайла, Веб);
	Если ПозВеб=1 Тогда
		Возврат Истина;		
	ИначеЕсли НАйти(ИмяФайла, Веб2) Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;

КонецФункции


// Загружает вопросы из файла или веб
Процедура ЗагрузитьВопросыИзФайла(ИмяФайла, ОчиститьИсторию) Экспорт
	
		
	Если ИмяФайлаЭтоВеб(ИмяФайла) Тогда
		// http
		ИмяДляЗагрузки=ПолучитьФайлССервера(ИмяФайла);
		УдалятьФайл=Истина;
		Если ПустаяСтрока(ИмяДляЗагрузки) Тогда
			Возврат;
		КонецЕсли
		
	Иначе
		ИмяДляЗагрузки = ИмяФайла;
		УдалятьФайл=Ложь;
	КонецЕсли;
		
	Если ОчиститьИсторию Тогда
		ОчиститьВсе();
	КонецЕсли;
	
	ЗагрузитьВопросыИзXML(ИмяДляЗагрузки);
	
	Если УдалятьФайл Тогда
		УдалитьФайлы(ИмяДляЗагрузки);
	КонецЕсли;
	
КонецПроцедуры


// <Описание процедуры>
Процедура ЗагрузитьВопросыИзМакета() Экспорт

	   //ПолучитьМакет
	//Двоичные = ПолучитьОбщийМакет("Загрузка");
	//ИмяФайла = ПолучитьИмяВременногоФайла("xml");
	//Двоичные.Записать(ИмяФайла);
	//
	//ЗагрузитьВопросыИзXML(ИмяФайла);
	//
	//УдалитьФайлы(ИмяФайла);

КонецПроцедуры 


Процедура ЗагрузитьВопросыИзXML(ИмяФайла) 
	
	
	//Если ПустаяСтрока(ИмяФайла) Тогда
	//	
	//	Сообщить("Укажите путь к файлу");
	//	Возврат;
	//КонецЕсли;
	
	ФайлПроверка = Новый Файл(ИмяФайла);
    Если НЕ ФайлПроверка.Существует() Тогда
		Сообщить("Файл не найден");
		Возврат;
    КонецЕсли;
	    
	Чтение = Новый ЧтениеXML;
	Чтение.ОткрытьФайл(ИмяФайла);
	н = 0;                                                                                                    
	Чтение.Прочитать();
	Чтение.Прочитать();
	
	ФлагКонец = Ложь;
	
	//ОчиститьВсе();
	
	//Попытки = 1;
	
	Пока НЕ ФлагКонец Цикл
		Попытка
			ТекОбъект = ПрочитатьXML(Чтение);
			ТипЗнчОбъект = ТипЗнч(ТекОбъект);
			//Сообщить(Строка(н) + " " + ТипЗнчОбъект);
			Если ТипЗнчОбъект = Тип("СправочникОбъект.Разделы") или ТипЗнчОбъект = Тип("СправочникОбъект.ВопросыИОтветы") Тогда
				ТекОбъект.Записать();
				
				Если ТипЗнчОбъект = Тип("СправочникОбъект.ВопросыИОтветы") Тогда
					н = н + 1;
				КонецЕсли;
			КонецЕсли;
		Исключение
			ФлагКонец = Истина;
		КонецПопытки;
		
	КонецЦикла;
	Чтение.Закрыть();
	Сообщить("Успешно прочитано " + Строка(н) + " вопросов!");
	
	
	
КонецПроцедуры

// Очистка всех вопросов и результатов тестирования
Процедура ОчиститьВсе()
	Выборка = Справочники.Разделы.Выбрать();
	Пока Выборка.Следующий() Цикл
		Об1 = Выборка.ПолучитьОбъект();
		Об1.Удалить();
	КонецЦикла;
	
	Выборка = Документы.РезультатТестирования.Выбрать();
	Пока Выборка.Следующий() Цикл
		Об1 = Выборка.ПолучитьОбъект();
		Об1.Удалить();
	КонецЦикла;
КонецПроцедуры


// Определяет это файл на компе или на веб
// Возвращает структуру с описанием
Функция РазобратьИмяФайла(ИмяФайла)
	
	СтрВозврат=Новый Структура;
	
	Веб =  "http://";
	
	ПозВеб=НАйти(ИмяФайла, Веб);
	Если ПозВеб=1 Тогда
		// http
		
		// Получаем адрес сервера и путь к файлу
		БезНачала=СтрЗаменить(ИмяФайла,Веб,"");
		ПозРазд = Найти(БезНачала, "/");
		ИмяСервера = Лев(БезНачала, ПозРазд-1);
		ФайлНаСервере = Прав(БезНачала, СтрДлина(БезНачала)-ПозРазд);
		
		СтрВозврат.Вставить("Тип", "Веб");
		СтрВозврат.Вставить("Сервер", ИмяСервера);
		СтрВозврат.Вставить("ИмяФайла", ФайлНаСервере);
		
		
	Иначе
		// Просто файл
		СтрВозврат.Вставить("Тип", "Файл");
		СтрВозврат.Вставить("ИмяФайла", ИмяФайла);
	КонецЕсли;
	
	Возврат СтрВозврат;
	
КонецФункции

Функция СтруктураURI(Знач СтрокаURI) Экспорт
	
	СтрокаURI = СокрЛП(СтрокаURI);
	
	// схема
	Схема = "";
	Позиция = Найти(СтрокаURI, "://");
	Если Позиция > 0 Тогда
		Схема = НРег(Лев(СтрокаURI, Позиция - 1));
		СтрокаURI = Сред(СтрокаURI, Позиция + 3);
	КонецЕсли;

	// строка соединения и путь на сервере
	СтрокаСоединения = СтрокаURI;
	ПутьНаСервере = "";
	Позиция = Найти(СтрокаСоединения, "/");
	Если Позиция > 0 Тогда
		ПутьНаСервере = Сред(СтрокаСоединения, Позиция + 1);
		СтрокаСоединения = Лев(СтрокаСоединения, Позиция - 1);
	КонецЕсли;
		
	// информация пользователя и имя сервера
	СтрокаАвторизации = "";
	ИмяСервера = СтрокаСоединения;
	Позиция = Найти(СтрокаСоединения, "@");
	Если Позиция > 0 Тогда
		СтрокаАвторизации = Лев(СтрокаСоединения, Позиция - 1);
		ИмяСервера = Сред(СтрокаСоединения, Позиция + 1);
	КонецЕсли;
	
	// логин и пароль
	Логин = СтрокаАвторизации;
	Пароль = "";
	Позиция = Найти(СтрокаАвторизации, ":");
	Если Позиция > 0 Тогда
		Логин = Лев(СтрокаАвторизации, Позиция - 1);
		Пароль = Сред(СтрокаАвторизации, Позиция + 1);
	КонецЕсли;
	
	// хост и порт
	Хост = ИмяСервера;
	Порт = "";
	Позиция = Найти(ИмяСервера, ":");
	Если Позиция > 0 Тогда
		Хост = Лев(ИмяСервера, Позиция - 1);
		Порт = Сред(ИмяСервера, Позиция + 1);
	КонецЕсли;
	
	Если ПустаяСтрока(Порт) И Схема = "https" Тогда
		Порт="443";
	КонецЕсли;

	
	Результат = Новый Структура;
	Результат.Вставить("Схема", Схема);
	Результат.Вставить("Логин", Логин);
	Результат.Вставить("Пароль", Пароль);
	Результат.Вставить("ИмяСервера", ИмяСервера);
	Результат.Вставить("Хост", Хост);
	Результат.Вставить("Порт", ?(Порт <> "", Число(Порт), Неопределено));
	Результат.Вставить("ПутьНаСервере", ПутьНаСервере);
	
	Возврат Результат;
	
КонецФункции





	



