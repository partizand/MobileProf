Функция ВыборВопроса(Очередь = "next")
	Запрос = Новый Запрос;
	
	НеПоказыватьУдаленные = РегистрыСведений.ХранилищеНастроек.ПолучитьНастройку("НеПоказыватьУдаленные", Истина);
	
	Запрос.УстановитьПараметр("НеПоказыватьУдаленные", НеПоказыватьУдаленные);
	
	Если НЕ ЗначениеЗаполнено(ТекущийРаздел) Тогда
		
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		               |	Разделы.Ссылка,
		               |	Разделы.НомерРаздела КАК НомерРаздела
		               |ИЗ
		               |	Справочник.Разделы КАК Разделы
		               |ГДЕ
		               |	ВЫБОР
		               |			КОГДА &НеПоказыватьУдаленные
		               |				ТОГДА НЕ Разделы.ПометкаУдаления
		               |			ИНАЧЕ ИСТИНА
		               |		КОНЕЦ
		               |
		               |УПОРЯДОЧИТЬ ПО
		               |	НомерРаздела";
		Выборка = Запрос.Выполнить().Выбрать();
		Если НЕ Выборка.Следующий() Тогда
			Возврат Неопределено;
		КонецЕсли;
		ТекущийРаздел = Выборка.Ссылка;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Раздел", ТекущийРаздел);
	Запрос.УстановитьПараметр("Вопрос", ТекущийВопрос);
	
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВопросыИОтветы.Владелец КАК Раздел,
	               |	ВопросыИОтветы.НомерВопроса КАК НомерВопроса
	               |ПОМЕСТИТЬ ВтТекущийВопрос
	               |ИЗ
	               |	Справочник.ВопросыИОтветы КАК ВопросыИОтветы
	               |ГДЕ
	               |	ВопросыИОтветы.Ссылка = &Вопрос
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	МИНИМУМ(ВопросыИОтветы.НомерВопроса) КАК МинНомерВопроса,
	               |	МАКСИМУМ(ВопросыИОтветы.НомерВопроса) КАК МаксНомерВопроса,
	               |	МИНИМУМ(&Раздел) КАК Раздел
	               |ПОМЕСТИТЬ ВтГраницы
	               |ИЗ
	               |	Справочник.ВопросыИОтветы КАК ВопросыИОтветы
	               |ГДЕ
	               |	ВЫБОР
	               |			КОГДА &НеПоказыватьУдаленные
	               |				ТОГДА НЕ ВопросыИОтветы.ПометкаУдаления
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |	И ВопросыИОтветы.Владелец = &Раздел
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ ПЕРВЫЕ 1
	               |	""first"" КАК Очередь,
	               |	ВопросыИОтветы.Ссылка,
	               |	ВопросыИОтветы.НомерВопроса
	               |ИЗ
	               |	Справочник.ВопросыИОтветы КАК ВопросыИОтветы
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтГраницы КАК ВтГраницы
	               |		ПО (ВтГраницы.МинНомерВопроса = ВопросыИОтветы.НомерВопроса)
	               |			И (ВтГраницы.Раздел = ВопросыИОтветы.Владелец)
	               |			И (ВЫБОР
	               |				КОГДА &НеПоказыватьУдаленные
	               |					ТОГДА НЕ ВопросыИОтветы.ПометкаУдаления
	               |				ИНАЧЕ ИСТИНА
	               |			КОНЕЦ)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ ПЕРВЫЕ 1
	               |	""last"",
	               |	ВопросыИОтветы.Ссылка,
	               |	ВопросыИОтветы.НомерВопроса
	               |ИЗ
	               |	Справочник.ВопросыИОтветы КАК ВопросыИОтветы
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтГраницы КАК ВтГраницы
	               |		ПО (ВтГраницы.МаксНомерВопроса = ВопросыИОтветы.НомерВопроса)
	               |			И (ВтГраницы.Раздел = ВопросыИОтветы.Владелец)
	               |			И (ВЫБОР
	               |				КОГДА &НеПоказыватьУдаленные
	               |					ТОГДА НЕ ВопросыИОтветы.ПометкаУдаления
	               |				ИНАЧЕ ИСТИНА
	               |			КОНЕЦ)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Очередь,
	               |	ВложенныйЗапрос.Ссылка,
	               |	ВложенныйЗапрос.НомерВопроса
	               |ИЗ
	               |	(ВЫБРАТЬ ПЕРВЫЕ 1
	               |		ВопросыИОтветы.Ссылка КАК Ссылка,
	               |		ВопросыИОтветы.НомерВопроса КАК НомерВопроса,
	               |		""prev"" КАК Очередь
	               |	ИЗ
	               |		Справочник.ВопросыИОтветы КАК ВопросыИОтветы
	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтТекущийВопрос КАК ВтТекущийВопрос
	               |			ПО (ВтТекущийВопрос.Раздел = ВопросыИОтветы.Владелец)
	               |				И (ВЫБОР
	               |					КОГДА &НеПоказыватьУдаленные
	               |						ТОГДА НЕ ВопросыИОтветы.ПометкаУдаления
	               |					ИНАЧЕ ИСТИНА
	               |				КОНЕЦ)
	               |				И ВопросыИОтветы.НомерВопроса < ВтТекущийВопрос.НомерВопроса
	               |	
	               |	УПОРЯДОЧИТЬ ПО
	               |		НомерВопроса УБЫВ) КАК ВложенныйЗапрос
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Очередь,
	               |	ВложенныйЗапрос.Ссылка,
	               |	ВложенныйЗапрос.НомерВопроса
	               |ИЗ
	               |	(ВЫБРАТЬ ПЕРВЫЕ 1
	               |		ВопросыИОтветы.Ссылка КАК Ссылка,
	               |		ВопросыИОтветы.НомерВопроса КАК НомерВопроса,
	               |		""next"" КАК Очередь
	               |	ИЗ
	               |		Справочник.ВопросыИОтветы КАК ВопросыИОтветы
	               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтТекущийВопрос КАК ВтТекущийВопрос
	               |			ПО (ВтТекущийВопрос.Раздел = ВопросыИОтветы.Владелец)
	               |				И (ВЫБОР
	               |					КОГДА &НеПоказыватьУдаленные
	               |						ТОГДА НЕ ВопросыИОтветы.ПометкаУдаления
	               |					ИНАЧЕ ИСТИНА
	               |				КОНЕЦ)
	               |				И ВопросыИОтветы.НомерВопроса > ВтТекущийВопрос.НомерВопроса
	               |	
	               |	УПОРЯДОЧИТЬ ПО
	               |		НомерВопроса) КАК ВложенныйЗапрос";
	//
	
	СтрРезультат = Новый Структура("Очередь, Ссылка, НомерВопроса");
	
	ТЗРезультат = Запрос.Выполнить().Выгрузить();
	Если Очередь = "next" Тогда
		НайденнаяСтрока = ТЗРезультат.НайтиСтроки(Новый Структура("Очередь", "next"));
		Если НайденнаяСтрока <> Неопределено и НайденнаяСтрока.Количество() > 0 Тогда
			ЗаполнитьЗначенияСвойств(СтрРезультат, НайденнаяСтрока[0]);
			Возврат СтрРезультат;
		КонецЕсли;
		
		НайденнаяСтрока = ТЗРезультат.НайтиСтроки(Новый Структура("Очередь", "first"));
		
		ЗаполнитьЗначенияСвойств(СтрРезультат, НайденнаяСтрока[0]);
		Возврат СтрРезультат;
		
	ИначеЕсли Очередь = "prev" Тогда
		
		НайденнаяСтрока = ТЗРезультат.НайтиСтроки(Новый Структура("Очередь", "prev"));
		Если НайденнаяСтрока <> Неопределено и НайденнаяСтрока.Количество() > 0 Тогда
			ЗаполнитьЗначенияСвойств(СтрРезультат, НайденнаяСтрока[0]);
			Возврат СтрРезультат;
		КонецЕсли;
		
		НайденнаяСтрока = ТЗРезультат.НайтиСтроки(Новый Структура("Очередь", "last"));
		
		ЗаполнитьЗначенияСвойств(СтрРезультат, НайденнаяСтрока[0]);
		Возврат СтрРезультат;
	Иначе
		
		НайденнаяСтрока = ТЗРезультат.НайтиСтроки(Новый Структура("Очередь", "first"));
		
		ЗаполнитьЗначенияСвойств(СтрРезультат, НайденнаяСтрока[0]);
		Возврат СтрРезультат;
		
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

&НаСервере
Процедура ПоказатьВопрос(СсылкаВопрос)
	
	ТекущийВопрос = СсылкаВопрос;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВопросыИОтветы.Владелец,
	               |	ВопросыИОтветы.Владелец.Наименование КАК НаименованиеРаздела,
	               |	ВопросыИОтветы.Владелец.НомерРаздела КАК НомерРаздела,
	               |	ВопросыИОтветы.НомерВопроса,
	               |	ВопросыИОтветы.Вопрос,
	               |	ВопросыИОтветы.ХранилищеКартинки
	               |ИЗ
	               |	Справочник.ВопросыИОтветы КАК ВопросыИОтветы
	               |ГДЕ
	               |	ВопросыИОтветы.Ссылка = &Вопрос
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВопросыИОтветыОтветы.НомерОтвета КАК НомерОтвета,
	               |	ВопросыИОтветыОтветы.Ответ,
	               |	ВопросыИОтветыОтветы.ЭтоПравильный
	               |ИЗ
	               |	Справочник.ВопросыИОтветы.Ответы КАК ВопросыИОтветыОтветы
	               |ГДЕ
	               |	ВопросыИОтветыОтветы.Ссылка = &Вопрос
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	НомерОтвета";
	
	Запрос.УстановитьПараметр("Вопрос", ТекущийВопрос);
	
	ПакетыЗапроса = Запрос.ВыполнитьПакет();
	ВыборкаВопрос = ПакетыЗапроса[0].Выбрать();
	ВыборкаВопрос.Следующий();
	
	Раздел = Строка(ВыборкаВопрос.НомерРаздела) + ". " + ВыборкаВопрос.НаименованиеРаздела;
	Вопрос = Строка(ВыборкаВопрос.НомерРаздела) + "." + Строка(ВыборкаВопрос.НомерВопроса) + ". " + ВыборкаВопрос.Вопрос;
	ТекущийРаздел = ВыборкаВопрос.Владелец;
	
	
	ДвоичныеДанныеКартинки = ВыборкаВопрос.ХранилищеКартинки.Получить();
	Если ДвоичныеДанныеКартинки = Неопределено или ДвоичныеДанныеКартинки.Размер() = 0 Тогда
		АдресКартинки = "";
		Элементы.Картинка.Видимость = Ложь;
	Иначе
		АдресКартинки = ПоместитьВоВременноеХранилище(ДвоичныеДанныеКартинки);
		Элементы.Картинка.Видимость = Истина;
	КонецЕсли;
	
	ВыборкаОтветы = ПакетыЗапроса[1].Выбрать();
	
	н = 1;
	
	Пока ВыборкаОтветы.Следующий() Цикл
		
		ЭлОтвет = Элементы["Ответ" + Строка(н)];
		ЭлОтвет.Заголовок = Строка(ВыборкаОтветы.НомерОтвета) + ". " + ВыборкаОтветы.Ответ;		
		
		Если ВыборкаОтветы.ЭтоПравильный Тогда
			ЭлОтвет.Шрифт = Новый Шрифт(ЭлОтвет.Шрифт,,,Истина,,Истина);
		Иначе
			ЭлОтвет.Шрифт = Новый Шрифт(ЭлОтвет.Шрифт,,,Ложь,,Ложь);
		КонецЕсли;
		
		ЭлОтвет.Видимость = Истина;
		
		н = н + 1;
	КонецЦикла;
	
	Пока н <= 10 Цикл
		
		ЭлОтвет = Элементы["Ответ" + Строка(н)];
		ЭлОтвет.Заголовок = "";		
		
		ЭлОтвет.Шрифт = Новый Шрифт(ЭлОтвет.Шрифт,,,Ложь,,Ложь);
		
		
		ЭлОтвет.Видимость = Ложь;
		
		н = н + 1;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура КомандаЗакрыть(Команда)
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПредыдущий(Команда)
	
	Рез = ВыборВопроса("prev");
	Если Рез.Очередь <> "prev" Тогда
		Если Вопрос("Это первый вопрос. Показать последний вопрос?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	ПоказатьВопрос(Рез.Ссылка);
КонецПроцедуры

&НаКлиенте
Процедура КомандСледующий(Команда)

	Рез = ВыборВопроса("next");
	Если Рез.Очередь <> "next" Тогда
		Если Вопрос("Это последний вопрос. Показать первый вопрос?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	ПоказатьВопрос(Рез.Ссылка);
КонецПроцедуры

&НаСервере
Процедура КомандаВыборРазделаНаСервере()
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура КомандаВыборРаздела(Команда)
	//КомандаВыборРазделаНаСервере();
	
	ОткрытьФорму("Справочник.Разделы.ФормаВыбора", Новый Структура("ТекущаяСтрока", ТекущийРаздел),ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если ТекущийВопрос.Пустая() Тогда
	
		Рез = ВыборВопроса("first");
		Тек = Рез.Ссылка;
	Иначе
		Тек = ТекущийВопрос;
	КонецЕсли;
	
	ПоказатьВопрос(Тек);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	Если ТипЗнч(ВыбранноеЗначение) = Тип("СправочникСсылка.Разделы") Тогда
		ТекущийРаздел = ВыбранноеЗначение;
		Рез = ВыборВопроса("first");
	
		ПоказатьВопрос(Рез.Ссылка);
	Иначе
		ПоказатьВопрос(ВыбранноеЗначение);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура КартинкаНажатие(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	Файл = ПолучитьИмяВременногоФайла(".jpg");
	ПолучитьИзВременногоХранилища(АдресКартинки).Записать(Файл);
	ЗапуститьПриложение(Файл,,Истина);
	#Если МобильноеПриложениеКлиент или МобильноеПриложениеСервер Тогда
	УдалитьФайлы(Файл);
	#КонецЕсли
КонецПроцедуры

&НаСервере
Процедура КомандаВыборВопросаНаСервере()
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура КомандаВыборВопроса(Команда)
	ОткрытьФорму("Справочник.ВопросыИОтветы.ФормаВыбора", Новый Структура("Владелец, ТекущаяСтрока", ТекущийРаздел, ТекущийВопрос),ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	ПриЗакрытииСервер1(ТекущийРаздел, ТекущийВопрос); //03.12.16 Кому-то это может показаться странным, но в версии 8.3.9.74 при попытке выбора раздела падает в этом месте с ошибкой (ПриЗакрытииСервер)
	//Бред конечно - связь не улавливаю.
	//Подозреваю, что добавили новое событие формы ПриЗакрытииСервер. На всякий случай сделал без контекста передачу на сервер, т.к. баг может скрываться и здесь - форма закрывается,
	//а в это время на сервер летит Контекст... - имхо
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ПриЗакрытииСервер1(ТекРаздел, ТекВопрос)
	РегистрыСведений.ХранилищеНастроек.ЗаписатьНастройку("Подготовка.ТекущийРаздел", ТекРаздел);
	РегистрыСведений.ХранилищеНастроек.ЗаписатьНастройку("Подготовка.ТекущийВопрос", ТекВопрос);
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	Если Вопрос("Закрыть?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		Отказ = Истина;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ТекНастр = РегистрыСведений.ХранилищеНастроек.ПолучитьНастройку("Подготовка.ТекущийРаздел");
	Если ТекНастр = Неопределено Тогда
		ТекущийРаздел = Справочники.Разделы.ПустаяСсылка();
	Иначе
		ТекущийРаздел = ТекНастр;
	КонецЕсли;
	
	ТекНастр = РегистрыСведений.ХранилищеНастроек.ПолучитьНастройку("Подготовка.ТекущийВопрос");
	Если ТекНастр = Неопределено Тогда
		ТекущийВопрос = Справочники.ВопросыИОтветы.ПустаяСсылка();
	Иначе
		ТекущийВопрос = ТекНастр;
	КонецЕсли;
КонецПроцедуры
